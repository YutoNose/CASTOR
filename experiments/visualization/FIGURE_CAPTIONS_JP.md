# Figure Captions & Paper Story

## 論文ストーリー

### タイトル案

**"Inverse Spatial Prediction Enables Selective Detection of Ectopic Anomalies in Spatial Transcriptomics"**

### 主張

遺伝子発現から空間位置を予測する「逆予測」により、空間的に誤配置された細胞（Ectopic異常）を**選択的に**検出できる。この能力は既存のグローバル異常検出手法と**独立かつ相補的**であり、組み合わせることで全異常タイプをカバーする。

### ストーリーの流れ

```
Fig 1 (概念)          → 何をするか
Fig 2 (選択性)        → 合成データで選択性を実証
Fig 3 (ロバスト性)    → 困難なシナリオでも機能
Fig 4 (独立性)        → 既存手法と相補的
Fig 5 (実データ基準)  → 一般的がん検出では最良ではない（誠実な報告）
Fig 6 (移植検証)      → 真のEctopic異常には最良（設計目的の検証）
Fig 7 (生物学的解釈)  → 高エラースポットはがんマーカーを発現
Fig S3 (解釈可能性)   → 予測変位の98.8%がドナー方向を指す
```

### 核心的ロジック

**Fig 5→Fig 6の転換が論文の核心**:
- Fig 5: 腫瘍は本来の位置にある → Ectopicではない → Inv_Posは低性能（AUC 0.58）
- Fig 6: 腫瘍発現を正常位置に移植 → 真のEctopic → Inv_Posが最良（AUC 0.89）
- **結論**: 手法は設計通りに機能する。「万能」ではなく「選択的」であることが価値。

---

## Figure 1: 概念図

**Figure 1: 空間トランスクリプトミクスにおける2種類の異常と逆予測アプローチ**

(a) **2種類の空間異常**。左: Ectopic異常は空間的に誤配置された細胞であり、Region Bの発現パターンを持つ細胞がRegion Aに存在する（赤星）。右: Intrinsic異常は位置は正常だが発現パターンが周囲と異なる細胞（青四角）。

(b) **Forward予測とInverse予測**。上: Forward予測は空間位置(x,y)から発現g(x,y)を予測し、発現が周囲から逸脱するIntrinsic異常を検出する。下: Inverse予測（本手法）は発現gから位置f(g)を予測し、発現と位置が不一致なEctopic異常を検出する。

(c) **Inverse位置予測パイプライン**。ST発現データをGNNエンコーダで潜在表現に変換し、位置デコーダが空間位置を予測する。予測位置と実際の位置の二乗誤差が異常スコアとなる。Ectopic細胞はドナー位置を予測するため、大きな誤差を生じる。Fig S3で実証：移植スポットの予測変位の98.8%がドナー方向を指す（コサイン類似度 > 0, p < 10^-187）。

### ストーリー上の役割
手法の概念的新規性と直感的理解を提供。Forward/Inverseの対称性が論文全体の基盤。

---

## Figure 2: 選択的検出の実証

**Figure 2: Inverse予測はEctopic異常のみを選択的に検出する**

(a) **クロス検出AUCヒートマップ**。行は検出手法、列は異常タイプ（Ectopic/Intrinsic）。Inv_PosErrorはEctopic検出でAUC 0.96を達成する一方、Intrinsic検出ではランダム（AUC 0.45）。一方、PCA_Error等のグローバル手法はIntrinsicでAUC > 0.97を達成するがEctopicは検出不可（AUC ≈ 0.45）。LISA、Neighbor_Diff等は両方を中程度に検出するが選択性を持たない。合成データ上での30シード、3,000スポット × 500遺伝子。

(b) **スコア分布の比較**。Inv_PosErrorはEctopic（赤）のみを高スコアとし、Normal（灰）とIntrinsic（青）を区別しない。PCA_ErrorはIntrinsic（青）のみを高スコアとする。この選択性が本手法の核心的特徴である。

(c) **選択性マップ**。x軸: Ectopic検出AUC、y軸: Intrinsic検出AUC。Inv_PosError（青星）は右下（Ectopic特異的: AUC 0.96）に、PCA_Error（橙四角）は左上（Intrinsic特異的: AUC 0.98）に位置する。他手法は対角線付近に集中し、選択性を持たない。

### ストーリー上の役割
本研究の中心的主張を定量的に実証。「常に最良」ではなく「選択的」であることが差別化ポイント。

---

## Figure 3: 困難なEctopicシナリオへのロバスト性

**Figure 3: 発現ブレンドにより検出が困難なEctopic異常（Hard Ectopic）でもInverse予測は機能する**

(a) **Easy Ectopic vs Hard Ectopicの模式図**。Easy Ectopicは遠方ドナーの発現を100%コピー（周囲と発現が明確に異なる）。Hard Ectopicはドナー発現50%+元の発現50%のブレンド（局所発現パターンが部分的に保持され、検出が困難）。

(b) **シナリオ別の手法比較**。Baseline（AUC 0.96）、Noisy Ectopic（AUC 0.96）、Partial Ectopic（AUC 0.88）、Hard Ectopic（AUC 0.79）、Hardest（AUC 0.79）でのEctopic検出AUC。Inv_PosError（青）は全条件でAUC > 0.78を維持。PCA_Error（橙）はHard条件でランダム以下に低下。Hard/Hardestシナリオ（ピンク背景）が本図の焦点。

(c) **Hard Ectopicシナリオの詳細**。Inv_PosError AUC = 0.79、PCA_Error AUC ≈ 0.47。逆予測のみが有意な検出能力を維持。

### 技術的注記
Hard Ectopicの困難さは**発現ブレンド率**（ドナー50%:元50%）に由来する。ドナーは依然として空間的に遠方から選択される（`distances > min_dist`）。ブレンドにより元の位置の発現特性が半分残るため、位置予測が部分的に正しくなり、検出が困難になる。

### 生物学的意義
発現ブレンドシナリオは以下の実世界の状況に対応する:
- **組織境界での混合発現**: 腫瘍-正常境界では、隣接組織の影響で中間的な発現プロファイルが生じる
- **部分的な表現型転換**: EMT（上皮間葉転換）途中の細胞は元の上皮特性を部分的に保持
- **技術的アーティファクト**: Visiumスポット（55μm径）が複数細胞を含む場合、混合発現が生じる
- **クローン初期段階**: 変異蓄積の初期段階では、正常発現と異常発現が混在

---

## Figure 4: グローバル手法との独立性と相補性

**Figure 4: Inverse予測スコアはグローバル手法と独立であり、組み合わせで全異常タイプを検出する**

(a) **スコア相関行列**。Inv_PosErrorとPCA_Error（r = -0.06）、LOF（r = -0.06）との相関はほぼゼロ。LISA（r = -0.00）、Neighbor_Diff（r = -0.02）とも独立。PCA_Error、Neighbor_Diff、LISAは互いに高相関（r > 0.81）。

(b) **スコア散布図**。x軸: Inv_PosError、y軸: PCA_Error。合成データ（3,000スポット、seed=42）で実際にモデルを訓練し、`compute_scores()`と`compute_pca_error()`で算出した実測スコアをプロット。Ectopic異常（赤三角）は右下（高Inv_PosError、低PCA_Error）に、Intrinsic異常（青四角）は左上（低Inv_PosError、高PCA_Error）に分離される。実測相関係数 r = -0.058（exp05の30シード平均）。

(c) **相補的検出**。Inv_Posのみ: Ectopic AUC 0.96, Intrinsic AUC 0.45。PCAのみ: Ectopic AUC 0.45, Intrinsic AUC 0.98。組み合わせ（max）: 両方AUC ≈ 0.90。独立性により、単純な組み合わせで全異常タイプをカバー。

### ストーリー上の役割
「既存手法の代替」ではなく「既存手法との組み合わせ」を提案。実用的な応用価値を示す。

---

## Figure 5: HER2陽性乳がんデータでの検証（一般的がん検出）

**Figure 5: 実データにおける手法比較 — Inverse予測は一般的がん検出には特化していない**

(a) **空間スコアマップ（模式図）**。異常スコアの空間分布を可視化。腫瘍領域（点線）付近にスコアの集中が見られる。

(b) **全手法比較（箱ひげ図）**。HER2ST 8サンプル × 30シードでの病理医アノテーション（cancer vs non-cancer）に対する検出AUC。LISA（0.76）、Isolation Forest（0.73）、Neighbor_Diff（0.73）、SpotSweeper（0.72）、LOF（0.71）が上位。STLearn（0.61）、GraphST（0.60）は中程度。Inv_PosError（0.58）、PCA_Error（0.57）も中程度。Squidpy（0.47）は低性能。

(c) **サンプル別性能**。8サンプル間で性能にばらつきがある。LISA（緑）は全サンプルで安定して高く、Inv_PosError（青）はサンプル依存性が大きい。

### 重要な解釈
**Inv_PosErrorがLISAに劣る理由**: HER2STの腫瘍細胞は本来の位置に存在する（Ectopicではない）。腫瘍は空間的にクラスター化しており、周囲との発現差が大きいため、局所比較手法（LISA）が有利。**これはInv_Posの弱点ではなく、設計上の選択性の表れである。** 次のFig 6でこの解釈を実証する。

---

## Figure 6: HER2ST腫瘍移植による真のEctopic検出検証

**Figure 6: 腫瘍発現の正常組織への移植により、Inverse予測がEctopic異常を最も効果的に検出することを実証**

(a) **H&E組織画像と病理医アノテーション（Sample G2）**。HER2陽性乳がん切片のH&E染色画像上に、病理医による組織ラベルをオーバーレイ。赤: invasive cancer、ピンク: cancer in situ、青: connective tissue、黄: adipose tissue、緑: breast glands、紫: immune infiltrate。G2サンプルは140スポットの浸潤がんと多様な正常組織を含む。

(b) **腫瘍→正常移植のデザイン**。赤スポット（腫瘍）から青スポット（正常）への発現プロファイルの移植を可視化。黄色星は移植先の30スポット。矢印はドナー→レシピエントの対応を示す。空間座標は変更せず、発現のみを置換することで、真のEctopic異常（腫瘍発現が正常位置に存在）を作成。

(c) **移植検出AUC（全8サンプル平均）**。Inv_PosError: 0.891 ± 0.077（最良）。LISA: 0.709。Neighbor_Diff: 0.682。Inv_Neighbor: 0.672。Isolation_Forest: 0.582。LOF: 0.491。PCA_Error: 0.122（反検出 — 腫瘍発現は正常に見える）。8サンプル × 10シード = 80回の独立実験。

(d) **サンプル別検出性能**。Inv_PosError（青）は全8サンプルで一貫してAUC > 0.7。LISA（緑）とNeighbor_Diff（桃）はサンプルによりばらつきが大きい。

### ストーリー上の役割
**Fig 5→Fig 6の転換が論文の核心**。Fig 5では腫瘍は本来の位置にあり、Inv_Posは中程度の性能。Fig 6では腫瘍発現を正常位置に移植し、真のEctopic異常を作成すると、Inv_Posが圧倒的に最良。**結論: 手法は設計通りに機能する。**

### 実験の公平性
- 教師なし学習: 移植ラベルは学習に一切使用せず、評価のみに使用
- 全手法が同一の修正データで評価（同一条件）
- HVG選択・正規化も修正データ上で実施（実応用を反映。教師なし設定では「クリーンデータ」は存在しない）

---

## Figure 7: 実データにおける遺伝子寄与解析

**Figure 7: Inverse予測の高エラースポットはHER2陽性がんの既知マーカー遺伝子を高発現する**

(a) **H&E組織画像上の位置予測誤差マップ（Sample G2）**。各スポットの色は位置予測誤差の大きさ（黄→赤のグラデーション）。黒丸は高エラースポット（上位10%）。組織構造と重ね合わせることで、高エラー領域が組織の特定の領域に集中していることが分かる。

(b) **Volcano plot**。x軸: log2 fold change（高エラースポット vs 低エラースポット）、y軸: -log10(p-value)。5シード横断でFisher結合p値を使用。赤: 有意に上方制御された遺伝子（3,481個）、青: 有意に下方制御された遺伝子（7個）。上位遺伝子: GNAS、ERBB2、CD46、TMSB10、CP。

(c) **Top 15有意差遺伝子**。Fisher結合p値によるランキング。全てp < 1e-10。GNAS（log2FC ≈ 1.0）、ERBB2（≈ 0.9）、CD46、TMSB10、SDC1が上位。

(d) **既知がんマーカーの発現パターン**。HER2シグナル（ERBB2, EGFR, GRB7）、接着分子（GNAS, SDC1, CD24, CD44, EPCAM, MUC1）、増殖マーカー（MKI67, PCNA, TOP2A, CCNB1, CDK1）、免疫マーカー（CD3D, CD8A, PTPRC, CD68, HLA-A）、構造タンパク質（KRT8, KRT18, KRT19, VIM, ACTB）。赤: 有意に上方制御、青: 有意に下方制御、灰: 非有意。ERBB2、GNAS、SDC1、CD24が最も強く上方制御。

### 生物学的意義
- **ERBB2**（HER2）が第2位の有意差遺伝子 → HER2陽性がんデータでERBB2がトップに来るのは生物学的に妥当
- **GRB7**: ERBB2の直接的シグナル伝達パートナー
- **SDC1、CD24**: がん細胞の接着と浸潤に関連
- **KRT19、KRT18**: 上皮がんマーカー
- 教師なしで学習したモデルが、ラベルなしでがん関連遺伝子を発見 → 生物学的妥当性の強い証拠

---

## Supplementary Figure S1: ノイズ耐性

**Figure S1: 発現ノイズに対するInverse予測の頑健性**

(a) **Dropout耐性**。遺伝子発現のdropout率を0-50%まで変化させた場合のEctopic検出AUC。Inv_PosError（青）はdropout 50%でもAUC ≈ 0.82を維持。PCA_Error（橙）は全dropout率でAUC ≈ 0.47（ランダム）を維持し、Ectopicに反応しないことが一貫。

(b) **ガウスノイズ耐性**。発現値へのガウスノイズ追加（σ = 0-1.0）に対する性能変化。Inv_PosErrorはσ = 0.5までAUC > 0.87を維持し、σ = 1.0でもAUC ≈ 0.79。

(c) **高Dropout条件（50%）での直接比較**。Inv_PosError AUC = 0.82、PCA_Error AUC = 0.47。50%の遺伝子がdropoutしてもInv_PosErrorは有意な検出を維持。

---

## Supplementary Figure S2: アブレーション解析

**Figure S2: モデルハイパーパラメータの感度分析**

(a) **位置損失重み（λ_pos）の影響**。λ_pos = 0ではEctopic検出不可（赤線、AUC ≈ 0.50）。λ_pos ≥ 0.1で高いEctopic AUC（≈ 0.95）。Intrinsic検出（青線）はλ_posの増加とともに低下。λ_pos = 0が唯一、Ectopic選択性が消失するパラメータ設定であり、位置予測が本手法の核心であることを裏付ける。

(b) **隠れ層次元の影響**。dim = 32-128の範囲でAUC ≈ 0.95と安定。ハイパーパラメータに対する低い感度を示す。

(c) **近傍数kの影響**。k = 5-30の全範囲でAUC ≈ 0.96。空間グラフ構築の近傍数は性能に影響しない。

(d) **λ_posとEctopic選択性の関係**。選択性 = Ectopic AUC − Intrinsic AUC。λ_pos = 0では選択性ゼロ。λ_pos ≥ 0.1で選択性 ≈ 0.45-0.50。位置予測損失がEctopic特異性の唯一の源泉。

---

## Supplementary Figure S3: 位置予測の解釈可能性（移植実験）

**Figure S3: 移植スポットの予測変位はドナー（腫瘍）位置の方向を指す**

(a) **予測変位ベクトルの空間マップ（Sample E1）**。正常位置（青丸）に腫瘍発現を移植したスポットに対し、モデルの予測変位ベクトル（actual→predicted）を矢印で表示。矢印の色はドナー方向とのコサイン類似度（緑: >0.5, 薄緑: 0~0.5, 薄赤: -0.5~0, 赤: <-0.5）。赤ダイヤ: ドナー位置（腫瘍）。17/17スポットの変位がドナー方向（cos sim > 0）を向いており、平均コサイン類似度 = 0.98。

(b) **コサイン類似度の分布**。予測変位ベクトルとドナー方向ベクトルのコサイン類似度のヒストグラム（n=1,135）。平均 = 0.925（赤線）、中央値 = 0.986。**98.8%のスポットでcos sim > 0**（予測変位がドナー方向を指す）。片側t検定 p ≈ 0、Wilcoxon符号順位検定 p = 8.32e-187。灰色破線: ランダム期待値（0）。

(c) **サンプル別の平均コサイン類似度**。8サンプル全てで平均 > 0.88（E1: 0.975、C1: 0.880）。エラーバーはシード間SD。全サンプルがドナー方向を指す（緑）。

(d) **移植距離とコサイン類似度の関係**。x軸: ドナー-レシピエント間距離（移植距離）、y軸: コサイン類似度。Spearman r = 0.406 (p = 3.6e-46)。移植距離が長いほどコサイン類似度が高い（遠方移植ほど方向がより明確にドナーを指す）。黒線: binned median + 95% CI。

### 技術的注記
- **コサイン類似度**の計算: displacement = (predicted - actual), donor_direction = (donor - actual), cos_sim = dot(displacement, donor_direction) / (|displacement| × |donor_direction|)
- cos sim > 0: 予測変位がドナーの方向を指す（方向が正しい）
- cos sim = 1: 予測変位が完全にドナー方向を指す
- cos sim < 0: 予測変位がドナーと反対方向を指す
- 「closer to donor」メトリクス（56.5%）より「コサイン類似度」（98.8% > 0）の方が本主張（「予測がドナーの方向を指す」）に適切。距離ではなく方向が重要。

### ストーリー上の役割
Fig 1(c)で主張する「Ectopic細胞の予測位置はドナー位置を指す」を定量的に実証。8サンプル × 5シード × 1,135移植スポットで、98.8%の予測変位がドナー方向を向いており、p = 8.32e-187で帰無仮説（ランダム方向）を棄却。

---

## Supplementary Figure S4: 統計解析

**Figure S4: 手法間の統計的比較**

(a) **シナリオ別性能ヒートマップ**。全手法 × 全シナリオ × 異常タイプのAUC。

(b) **ペアワイズ有意差検定**。Bonferroni補正後のp値。Inv_PosErrorはグローバル手法と有意に異なる（p < 0.001）。

(c) **効果量（Cohen's d）**。Inv_PosError vs 各手法。全てlarge effect（d > 0.8）。

(d) **95%信頼区間**。各手法のEctopic検出AUCの信頼区間。Inv_PosErrorの下限は他手法の上限を上回る。

---

## Supplementary Figure S5: スケーラビリティ

**Figure S5: 大規模データセットへのスケーラビリティ**

(a) 計算時間 vs スポット数。1,000-30,000スポットでの実行時間。GNNベースのInv_PosはO(n log n)でスケール。

(b) メモリ使用量 vs スポット数。疎グラフ表現で効率的。

(c) 性能安定性。スポット数によらずAUCは安定。

---

## Supplementary Figure S6: 合成データの統計的特性

**Figure S6: ベンチマークに使用した合成空間トランスクリプトミクスデータの特性**

(a) **空間分布**。3,000スポットの空間配置。赤: Ectopic異常（n=100, 3.3%）、青: Intrinsic異常（n=300, 10%）、灰: 正常（n=2,600）。Ectopicは遠方ドナーから発現を移植されたスポット、Intrinsicは発現がノイズで撹乱されたスポット。

(b) **遺伝子発現統計**。500遺伝子 × 3,000スポットの発現行列。ZINB分布（dispersion=2.0, dropout_rate=0.3）から生成。左: 遺伝子あたりの平均発現量の分布。右（inset）: スポットあたりのライブラリサイズ分布。

(c) **異常注入の可視化**。Ectopic注入: ドナースポット（赤星）の発現をレシピエント（赤点）に移植。矢印はドナー→レシピエントの対応。Intrinsic注入: ガウスノイズ（σ=2.0）を加算して発現を撹乱。

(d) **パラメータ一覧表**。データ生成の全パラメータ: n_spots=3,000、n_genes=500、n_ectopic=100（3.3%）、n_intrinsic=300（10%）、dispersion=2.0、dropout_rate=0.3、noise_scale=2.0、k_neighbors=15。モデル: hidden_dim=64、n_epochs=100、lambda_pos=0.5、dropout=0.3。

---

## 論文構成案

### Abstract (150語)
空間トランスクリプトミクスにおいて、発現パターンから空間位置を予測する「逆予測」アプローチにより、空間的に誤配置された細胞（Ectopic異常）を選択的に検出する手法を提案する。合成データ実験でEctopic検出AUC 0.96を達成し、困難なシナリオでもAUC 0.79を維持。グローバル手法（PCA, LOF）との相関はほぼゼロ（r ≈ -0.06）であり、組み合わせにより全異常タイプを検出可能。HER2陽性乳がんの空間トランスクリプトミクスデータで、腫瘍発現の正常組織への移植実験によりAUC 0.891を達成。移植スポットの予測変位の98.8%がドナー位置の方向を指し（コサイン類似度 > 0, p < 10^-187）、逆予測の解釈可能性を実証。教師なしの遺伝子寄与解析により、高エラースポットがERBB2をはじめとするHER2+がんマーカーを高発現することを発見。

### Main Text 構成

1. **Introduction**: 空間異常検出の課題、Forward vs Inverse の概念
2. **Results**:
   - 逆予測はEctopic異常を選択的に検出する (Fig 1, 2)
   - 困難なシナリオでのロバスト性 (Fig 3)
   - グローバル手法との独立性と相補性 (Fig 4)
   - 実データでの位置づけ: 一般がん検出 vs Ectopic検出 (Fig 5, 6)
   - 高エラースポットの生物学的解釈 (Fig 7)
3. **Discussion**: 限界と展望
4. **Methods**: モデル構造、学習、評価、データ

### 論文の強み
1. **概念的新規性**: 発現→位置の逆予測を異常検出に初適用
2. **誠実な評価**: Fig 5で手法が最良でない場面を正直に報告
3. **実データ検証**: 捏造なし、H&E画像・病理アノテーション付き
4. **生物学的妥当性**: ERBB2がトップ → ラベルなしでがんマーカー発見
5. **相補性**: 「既存手法の代替」ではなく「既存手法との組み合わせ」
6. **解釈可能性**: 予測変位の98.8%がドナー方向（コサイン類似度 > 0, p < 10^-187, Fig S3）

### 論文の限界（Discussion用）
1. Ectopic異常の頻度は未知（どのくらい実際に起きるか）
2. HER2STのみで検証（他組織・他技術での検証が望ましい）
3. モデルは空間グラフ構造に依存（解像度が粗いと近傍関係が不正確）
4. 計算コスト: GNN学習が必要（ただしS5で許容範囲を示す）

---

## コード検証結果

### exp16 (遺伝子寄与解析)
- **修正済み**: log2FC計算がlnスケールだったのをlog2スケールに修正
- Fisher結合p値: 正しく実装
- BH FDR補正: 2段階適用（保守的だが問題なし）
- データリーク: なし（教師なし学習、ラベルは評価のみ）

### exp17 (移植実験)
- 移植ロジック: 正常スポットの発現を腫瘍発現で置換（座標は不変）
- 教師なし学習: 確認済み（移植ラベルは学習に不使用）
- ベースライン公平性: 全手法が同一の修正データで評価
- **「HVG選択・正規化をmodified dataで行っている」はデータリークではない**: 教師なし設定では入力データをそのまま前処理するのが正しい。「クリーンデータ」で前処理することは、どのスポットが異常かの知識を暗に利用することになり、むしろリーク

### exp15 (フルベンチマーク)
- **修正済み**: `run()`関数が欠落していたため追加（CLI互換性）
- **修正済み**: シード設定が`range(n_seeds)` = [0,1,...,29]だったのを`config.seeds` = [42,...,71]に統一
- 関数シグネチャを`n_seeds`パラメータから`seeds`パラメータに変更

### コアモジュール (preprocessing, models, baselines)
- 全モジュール検証済み: 数学的に正しく、ラベルリークなし
- 正規化: log1p + z-score（遺伝子ごと）— data_generation.pyの二重log1pバグを修正済み（raw counts → prepare_data → single log1p）
- グラフ構築: k-NNで自己ループ除去
- 位置予測: [0,1]正規化座標上のMSE
- 全ベースライン: 正しく実装、ラベル不使用
- OCSVM: random_state引数追加で再現性保証
- exp04ノイズ関数: np.random.seed → np.random.RandomState（ローカル乱数状態）に修正
- **修正済み**: `scenarios.py`のデフォルト`n_intrinsic=200` → 300（DEFAULT_CONFIGと一致）
- **修正済み**: `data_generation.py`のデフォルト`n_spots=2000` → 3000（DEFAULT_CONFIGと一致）
- **修正済み**: `baselines.py`のMahalanobis距離でEllipticEnvelope失敗時にwarnings.warnを追加

---

## 想定査読への対策

### Reviewer 1: 機械学習方法論の専門家

**Q1: 「Ectopic異常は人工的。実際の生物学でいつ発生するのか？」**

> Ectopic異常は以下の場面で発生する:
> 1. **がん転移**: 転移性腫瘍細胞は原発巣の発現プロファイルを保持しつつ、異なる組織に存在する（Patel et al., Science 2014）
> 2. **組織切片のアーティファクト**: ST実験の切片作製時に、組織の折り畳みや断裂により細胞が本来と異なる位置にキャプチャされる（Ståhl et al., Science 2016）
> 3. **免疫細胞浸潤**: 腫瘍微小環境では、血液由来の免疫細胞が組織内に浸潤し、局所的な発現コンテキストと不一致になる
> 4. **発生過程での細胞移動**: 神経堤細胞など、発生中に長距離移動する細胞は移動途中で「ectopic」な状態にある
> 5. **Visiumの混合スポット**: 55μm径のスポットが複数の組織領域にまたがる場合、混合発現が生じる
>
> **対応Figure**: Fig 6（HER2ST移植実験）が最も直接的な証拠。病理医アノテーション付きの実組織で、腫瘍発現を正常位置に移植した結果、AUC 0.891で検出に成功。

**Q2: 「合成データが単純すぎる。実データはもっとノイジー。」**

> 合成データの限界は認識しており、以下で補完している:
> 1. **Fig S1**: dropout 50%でもAUC 0.82、ガウスノイズσ=1.0でもAUC 0.79を維持 → ノイズ耐性を実証
> 2. **Fig 5**: 実データ（HER2ST 8サンプル）での評価を提供
> 3. **Fig 6**: 半合成実験（実組織+実発現プロファイルの移植）で実データの複雑性を反映
> 4. **Fig 7**: 完全に未改変の実データでの遺伝子解析 → ERBB2がトップ → 生物学的妥当性
>
> 合成データは制御された条件での手法検証に不可欠であり、Fig 5-7の実データ結果と合わせて、手法の汎用性を示している。

**Q3: 「k-NN距離ベースの単純なベースラインと比較していないのはなぜか？」**

> 比較済みである:
> - **Neighbor_Diff**: 各スポットとk-NN近傍の発現差のL2ノルム。これはk-NN距離ベースの手法に相当する。Fig 2でAUC（Ectopic: 0.58, Intrinsic: 0.97）と報告済み。Inv_PosError（Ectopic: 0.96）との差は明確。
> - **LOF**: Local Outlier Factorは発現空間でのk-NN密度比。Fig 2で報告済み（Ectopic: 0.45）。
> - Neighbor_Diffは「空間的な発現の不一致」を測定するが、Ectopic検出には不十分。なぜなら、Ectopic細胞の近傍は（移動先の）正常細胞であり、一つの外れ値が近傍平均を大きく動かさないため。

---

### Reviewer 2: バイオインフォマティクス / ST専門家

**Q1: 「Fig 5でInv_PosErrorの性能が低い。なぜこの手法を使うべきか？」**

> Fig 5の結果は手法の**設計上の特性**を正確に反映している:
> - HER2STの腫瘍は**本来の位置に存在**する → Ectopicではない → Inv_Posは検出しない（AUC 0.58）
> - LISAが高性能なのは、腫瘍が**空間的にクラスター化**し周囲と発現が異なるため（局所比較手法の得意なケース）
> - **Fig 6が決定的な反論**: 腫瘍発現を正常位置に移植すると（= 真のEctopic）、Inv_PosがAUC 0.891で最良、LISAは0.709に低下
> - **結論**: 「常に最良」ではなく「Ectopicに特化」。異常のタイプに応じた手法選択が重要であり、それ自体が本論文の貢献。

**Q2: 「LISAで十分。追加手法の必要性は？」**

> LISAでは検出できないケースが存在する:
> 1. **Hard Ectopic**（Fig 3）: LISAはAUC ≈ 0.5（ランダム）、Inv_PosはAUC 0.79。発現が局所的に類似している場合、LISAは機能しない。
> 2. **独立性**（Fig 4）: Inv_PosとLISAの相関はr = 0.00 → 完全に独立な情報。組み合わせることで両方の異常タイプをカバー（Fig 4c: Combined AUC ≈ 0.90）。
> 3. **解釈性**（Fig 7, Fig S3）: Inv_Posは「どこから来たか」（予測位置→ドナー推定）を提供。Fig S3で実証：予測変位の98.8%がドナー方向を指す（cos sim > 0, p < 10^-187）。LISAは「近傍と違う」としか言えない。
> 4. **PCA_Error反検出**（Fig 6c）: 移植実験でPCA_ErrorのAUC=0.122。グローバル手法は腫瘍発現を「正常」と見なす。Ectopic検出にはInv_Posが不可欠。

**Q3: 「HER2STのみ。他組織・他プラットフォームでの汎化性は？」**

> 現時点の限界として認識している。以下を回答に含める:
> 1. HER2STは8サンプル × 10シード = 80回の独立実験で評価 → サンプル数は限定的だが統計的に安定
> 2. 手法はST技術に依存しない汎用的な枠組み（発現行列 + 座標のみが入力）
> 3. Fig S5でスケーラビリティを実証（30,000スポットまで）→ Slide-seq等にも適用可能
> 4. **Limitation/Discussion**: 他組織（脳、腸、肺等）・他プラットフォーム（MERFISH, Slide-seq, Stereo-seq）での追加検証を今後の課題として明記

---

### Reviewer 3: 統計学の専門家

**Q1: 「AUCはクラス不均衡に対して楽観的。AUPRC等も報告すべき。」**

> 妥当な指摘である。対応:
> 1. exp17では`average_precision_score`も計算済み（`auprc_inv_pos`列）→ Supplementary Tableに追加可能
> 2. 合成データではEctopic 3.3%（n=100/3,000）、Intrinsic 10%（n=300/3,000）→ 不均衡は中程度
> 3. HER2ST移植実験: 30/467 = 6.4%が異常 → 実際のアプリケーションに近い不均衡率
> 4. **追加対応**: revision時にAUPRC、F1@optimal threshold、precision@recall=0.8を全実験に追加可能。実装は`sklearn.metrics`で即座に対応可能。

**Q2: 「exp16のFDR補正が2段階。統計的に正しいか？」**

> 2段階FDR（per-seed BH + cross-seed Fisher + BH）は**保守的**であり、偽陽性は過小評価される方向:
> 1. 第1段階: 各シード内で15,000遺伝子のBH補正 → per-seed FDR制御
> 2. 第2段階: Fisher結合p値で5シード横断の集約 → cross-seed統合
> 3. 第3段階: 結合p値にBH補正 → 最終FDR制御
> 4. 2段階目のFisherは未補正p値で行うのがより標準的（Whitlock 2005）。ただし現実装は保守的方向のバイアスであり、**偽陽性は増えない**。有意差遺伝子が少なめに報告される可能性がある程度。
> 5. **追加対応**: revision時に1段階目を省略してFisher → BHのみの結果も併記可能。

**Q3: 「8サンプルでは一般化可能な結論は出せない。」**

> 8サンプルの制約は認識している。以下で緩和:
> 1. **シード × サンプルの反復**: 8サンプル × 10シード = 80回の独立評価で分散を推定
> 2. **サンプル間の一貫性**: Fig 6d で全8サンプルでInv_Pos > 0.7を示し、一貫した傾向を確認
> 3. **効果量**: Cohen's d > 0.8（large effect）→ 小標本でも検出力は十分（Fig S4）
> 4. **合成データとの整合**: 合成データ（30シード）の結果と実データの結果が一致 → 手法の原理的正しさを裏付け
> 5. **Limitation**: HER2STは利用可能な最大の病理アノテーション付きSTデータセットの一つ。他データセットでの追加検証は今後の課題。

---

### Reviewer 4: がん生物学の専門家

**Q1: 「Ectopic異常を検出して何に使えるのか？臨床的意義は？」**

> 以下の応用が期待される:
> 1. **品質管理**: ST実験のアーティファクト検出（組織の折り畳み、断裂、汚染スポットの同定）
> 2. **転移性細胞の同定**: 原発巣と異なる組織内に存在する転移性腫瘍細胞は、周囲の空間コンテキストと不一致な発現を持つ → Inv_Posで検出可能
> 3. **免疫細胞の空間マッピング**: 腫瘍微小環境に浸潤する免疫細胞は、周囲の腫瘍細胞と異なる発現を持ちながら、グローバルには正常 → PCAでは検出不可、Inv_Posで検出可能
> 4. **異常タイプの区別**: Inv_Pos（ectopic）+ PCA（intrinsic）の組み合わせで、「どこから来た異物か」vs「その場で異常になったか」を区別 → 生物学的メカニズムの理解に直結
> 5. **Fig 7のERBB2発見**: 教師なしでHER2マーカーを発見 → バイオマーカースクリーニングツールとしてのポテンシャル

**Q2: 「Fig 7の遺伝子解析はがんマーカーを見つけただけ。既知の結果では？」**

> 既知マーカーの再発見は**手法の妥当性検証（validation）**であり、それ自体が重要:
> 1. **教師なし発見**: モデルはがんラベルを一切使わずに学習。高エラースポットが自動的にERBB2を高発現 → 生物学的に正しい結果を教師なしで再発見
> 2. **技術的新規性**: 「位置予測誤差が高いスポット」という切り口でDEGを行うのは本研究が初。従来の「がんvs正常」DEGとは異なるアングル
> 3. **GNASの発見**: ERBB2に次いでGNAS（Gαsタンパク質）が第1位 → HER2シグナルのGPCR経路との関連が示唆され、新規の生物学的知見の可能性
> 4. **定量的意義**: 3,481遺伝子が有意差 → 発現プログラム全体が空間的文脈に依存することの証拠

**Q3: 「Deconvolution手法（cell2location, RCTD等）との比較は？」**

> Deconvolutionと本手法は**異なるタスク**を解決する:
> 1. **Deconvolution**: 各スポットの細胞型組成を推定 → 「何の細胞がいるか」
> 2. **本手法**: 各スポットの発現が空間コンテキストに合致するか → 「その細胞はここにいるべきか」
> 3. DeconvolutionはリファレンスscRNA-seqが必要（教師あり）。本手法は教師なし。
> 4. 将来的には、deconvolution結果と組み合わせて「予期しない細胞型が予期しない位置にある」ことを検出するパイプラインが有望 → Discussion/Future workに記載。

---

### Reviewer 5: 再現性・方法論の専門家

**Q1: 「ハイパーパラメータが多い。チューニングの影響は？」**

> Fig S2（アブレーション）で網羅的に検証済み:
> 1. **λ_pos** (位置損失重み): λ=0のみが性能低下。λ ∈ [0.1, 2.0]で安定（AUC 0.95 ± 0.01）
> 2. **hidden_dim**: dim ∈ [32, 128]で安定（AUC 0.95 ± 0.005）
> 3. **k_neighbors**: k ∈ [5, 30]で安定（AUC 0.96 ± 0.002）
> 4. **結論**: λ_pos > 0 が唯一の重要な条件。他パラメータへの感度は極めて低い。
> 5. デフォルト設定（λ=0.5, dim=64, k=15）は全実験で固定 → チューニングなし。

**Q2: 「高解像度STプラットフォーム（MERFISH, Stereo-seq等）への適用は？」**

> 原理的に適用可能:
> 1. 入力は「発現行列 + 空間座標」のみ → プラットフォーム非依存
> 2. Fig S5: 30,000スポットまでスケール確認 → MERFISH（数十万細胞）にはバッチ処理が必要
> 3. 高解像度では空間グラフがより密になるため、k-NNのkを調整する必要がある（ただしFig S2cでk=5-30に非感受性を確認）
> 4. 遺伝子パネルが小さい場合（MERFISH: ~500遺伝子）: 位置予測に十分な情報があるかは要検証 → 今後の課題
> 5. **Limitation**: 本研究はVisium解像度（~100μm）で検証。サブセルラー解像度での検証は将来課題。

**Q3: 「コードとデータの公開は？」**

> 完全な再現性を保証する:
> 1. **コード**: GitHubリポジトリで公開（全実験スクリプト、コアモジュール、可視化コード）
> 2. **データ**: HER2STデータはZenodo 3957257で公開済み（Andersson et al. 2021）
> 3. **再現**: `python cli.py exp all` で全実験を再実行可能。`python cli.py fig all` で全図を再生成。結果CSVファイルも提供
> 4. **環境**: `requirements.txt` で依存パッケージを固定。PyTorch + PyG + scikit-learn
> 5. **シード管理**: 全実験でnp.random.seed + torch.manual_seedを固定 → 完全再現可能

**Q4: 「教師なしと言っているが、座標情報を使っている。これは一種のラベルではないか？」**

> 空間座標は**ラベルではなく、データの本質的な構成要素**である:
> 1. STデータの定義: 「各スポットの発現ベクトル + 空間座標」が1データ点。座標は入力の一部であり、外部ラベルではない
> 2. 「教師なし」の定義: 異常ラベル（normal/ectopic/intrinsic）を学習に使用しないこと。座標は全スポットに平等に与えられ、異常の有無に依存しない
> 3. **類似例**: PCAが全次元を使うのと同様に、本手法は空間次元を使う。PCAを「教師なし」と呼ぶのと同じ論理
> 4. Fig S2a: λ_pos=0（座標を使わない）ではEctopic検出不可 → 座標情報がEctopic検出に**必要**であることの証拠であり、この点が本手法の新規性

**Q5: 「モデルは学習データの異常も含めて学習する。異常が多い場合に性能低下しないか？」**

> 妥当な懸念。以下で対応:
> 1. 本実験の異常率: 合成データ3.3%+10%=13.3%、移植実験6.4% → 少数派であり、多数の正常スポットが学習を支配
> 2. 教師なし異常検出の標準的仮定: 「異常は少数派」（contamination assumption）。これはLOF、IsolationForest等の全ての教師なし手法に共通
> 3. 異常率を上げた場合の検証は今後の課題として明記可能
> 4. **現実**: STデータでは異常（= 空間的に誤配置された細胞）が全体の50%を超えることはほぼない → 仮定は妥当
